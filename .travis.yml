language: python

env:
  global:
    - TWINE_USERNAME=__token__ # password in Travis settings

matrix:
  include:
    # For generic source distribution
    - os: linux
      python: 3.8
      sudo: required
      install: python setup.py sdist
    # For macOS wheels
    - os: osx
      language: generic
    # For 64-bit x86 manylinux wheels
    - sudo: required
      services:
        - docker
      env: PLAT=manylinux2010_x86_64
      install:
        - docker pull quay.io/pypa/$PLAT
        - ls -la
        - docker run --rm -it -v `pwd`:/io quay.io/pypa/$PLAT /io/manylinux.sh
      script: skip
    # For 32-bit x86 manylinux wheels
    - sudo: required
      services:
        - docker
      env: PLAT=manylinux2010_i686
      install:
        - docker pull quay.io/pypa/$PLAT
        - docker run --rm -it -v `pwd`:/io quay.io/pypa/$PLAT linux32 /io/manylinux.sh
      script: skip

before_install:
  - python -m pip install -U wheel twine

install:
  - python setup.py bdist_wheel

script:
  - python -m pip install -U --force-reinstall --no-index --find-links=./dist pysdl2-dll
  - python -m pip install pytest git+https://github.com/marcusva/py-sdl2.git
  - pytest -s

after_success: |
  if [[ $TRAVIS_TAG ]]; then
    if [ $(uname) = "Darwin" ]; then
      python -m twine upload --skip-existing dist/*.whl
    else
      python -m twine upload --skip-existing dist/*.tar.gz
    fi
  fi
